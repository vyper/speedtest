require 'test_helper'
require 'speedtest/configuration'

describe Speedtest::Configuration do
  subject { Speedtest::Configuration.new }

  before do
    body = "<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<settings>\n<client ip=\"127.0.0.1\" lat=\"-24.0500\" lon=\"-52.3667\" isp=\"Ts Tecnologia E Sistemas Em Redes Ltda\" isprating=\"2.5\" rating=\"5\" ispdlavg=\"3905\" ispulavg=\"1184\" loggedin=\"0\" />\n<server-config threadcount=\"4\" ignoreids=\"683,1525,1719,1758,1762,1815,1816,1834,1839,1840,1850,1854,1859,1860,1861,1871,1873,1875,1877,1880,1913,3280,3383,3448,3695,3696,3697,3698,3699,3725,3726,3727,3728,3729,3730,3731,3733,3788,3913,4140,4533,4787,5023,5024,5025,5026,5027,5028,5029,5030,5031,5032,5033,5085,5086,5087,5107,5108,5109,5111,5112,5113,5114,5115,5116,5117,5118,5348,5517,5894,6130,6285,6397,6398,6412,7211,7326,7334,7529,949,5249\" notonmap=\"8036,7907,4179,2690,5718,6051,4231,4810,4781,6735,2801,5237,6931,6768,7228,4692,4689,7775,7594,6891,8009,7322,5478,4467,5844,4908,1930,4745,6866,6616,7439,7008,6563,6307,4984,5285,6053,5201,8367,8072,6827,4381,6985,5580,6562,4472,5581,2322,5040,7531,2724,6479,1832,8205,7853,5950,6430,2696,6254,3868,5147,7579,7303,4219,1119,4521,3704,3326,7532,6590,5664,5206,4493,7618,5211,5651,3149,2636,1000,5046,2264,7361,1904,7396,5284,7619,6059,4078,226,5911,385,8066,8281,7352,7437,4008,5090,4778,2802,6522,5679,2822,5477,5072,6446,6195,6010,1108,831,5884,5447,7743,6578,8142,7560,8040,7803,8196,8223,8068,6589,2356,4396,8035,8051,5305,2713,4269,972,1688,5582,4838,6614,4708,6070,7412,6635,7354,7251,7842,6851,2443,2796,6769,5707,4714,3583,6553,7638,8155,7525,6689,2334,7839,8211,7757,6953,5331,7044,2635,4811,7088,4290,1483,2155,7758,7686,7609,8107,4169,4590,4659,6737,4453,515,3860,4049,5210,2565,7384,7537,7829,7870,4962,2485,2978,1903,7440,7403,7617,6973,7283,3079,7898,5463,6485,8342,7467,7193,7188,3104,5934,2896,7367,4374,1755,8364,8147,7111,6672,7246,6267,1781,7170,7546,6903,3747,6474,7296,4589,4375,4606,7640,4349,5875,5098,4317,6272,6286,6794,3422,6722,6855,3007,6248,6047,3864,5602,5303,5905,6076,7244,8175,7456,8049,7048,7190,6299,8169,2618,6561,7671,6007,3567,5534,6074,4680,2586,1266,4081,7859,6937,8031,2812,7847,7382,6588,7256,7491,3197,4937,6782,3892,4848,5942,7946,6838,1999,2327,5315,2188,5661,7429,5528,6401,6707,1441,4871,7469,7076,6597,6391,3458,3624,3615,6658,7147,4535,4406,6407,6410,4728,7327,6767,7198,2552,2428,3870,5415,6454,4641,8129,8308,7950,7605,8131,6746,4883,5965,6675,8122,4196,5079,5311,4491,2679,6783,5779,7954,6708,7319,6749,7128,5230,4299,6683,7521,7805,7205,3855,6283,5920,5609,7662,8037,5394,6194,7115,6521,5431,7223,6243,7408,2583,7231,4165,7239,7379,7971,7868,4706,7784,6756,5797,6610,4673,1452,2504,8158,6970,4442,7474,8372,7711,6618,4085,4306,6537,4161,6858,6213,4067,480,2213,5935,4235,367,5304,6341,5168,7311,7556,7368,7009,7046,5748,4445,6370,7122,6348,7938,8229,7425,4614,4615,5356,4210,5777,7582,5248,7410,7959,6281,7680,7438,7762,7272,6146,6612,6833,4594,8261,4726,5963,3846,2821,6480,6110,5065,6493,7397,7370,4909,7581,3611,8370,6535,4921,6615,4992,5557,6829,7612,6773,6533,4147,5696,4545,7690,4899,8290,5281,3759,6246,7254,6921,6688,7761,2963,6154,5205,1931,7631,1267,6355,3234,8380,6314,5744,5868,6093,7318,2962,1818,7166,5203,7696,7206,6825,4336,5469,2720,4953,5539,5749,4775,5412,8345,7279,7393,2169\" forcepingid=\"\" preferredserverid=\"\" />\n<licensekey>9c1687ea58e5e770-1df5b7cd427370f7-4b62a84526ea1f56</licensekey>\n<customer>speedtest</customer>\n<odometer start=\"8400470528\" rate=\"19\" />\n<times dl1=\"5000000\" dl2=\"35000000\" dl3=\"800000000\" ul1=\"1000000\" ul2=\"8000000\" ul3=\"35000000\" />\n<download testlength=\"10\" initialtest=\"250K\" mintestsize=\"250K\" threadsperurl=\"4\" />\n<upload testlength=\"10\" ratio=\"5\" initialtest=\"0\" mintestsize=\"32K\" threads=\"2\" maxchunksize=\"512K\" maxchunkcount=\"50\" threadsperurl=\"4\" />\n<latency testlength=\"10\" waittime=\"50\" timeout=\"20\" />\n<socket-download testlength=\"15\" initialthreads=\"4\" minthreads=\"4\" maxthreads=\"32\" threadratio=\"750K\" maxsamplesize=\"5000000\" minsamplesize=\"32000\" startsamplesize=\"1000000\" startbuffersize=\"1\" bufferlength=\"5000\" packetlength=\"1000\" readbuffer=\"65536\" />\n<socket-upload   testlength=\"15\" initialthreads=\"dyn:tcpulthreads\" minthreads=\"dyn:tcpulthreads\" maxthreads=\"32\" threadratio=\"750K\" maxsamplesize=\"1000000\" minsamplesize=\"32000\" startsamplesize=\"100000\" startbuffersize=\"2\" bufferlength=\"1000\" packetlength=\"1000\" disabled=\"false\" />\n<socket-latency testlength=\"10\" waittime=\"50\" timeout=\"20\" />\n<conditions>\n<cond name=\"tcpulthreads\" download=\"+100000\" value=\"8\" />\n<cond name=\"tcpulthreads\" download=\"+10000\" value=\"4\" />\n<cond name=\"tcpulthreads\" value=\"2\" />\n</conditions><interface template=\"mbps\" colortcp=\"0\" />\n<translation lang=\"xml\" >\n<text id=\"rateyourisp\">Rate Your ISP</text>\n<text id=\"copy\">COPY IP</text>\n<text id=\"long-kbps\">kilobits</text>\n<text id=\"long-Mbps\">megabits</text>\n<text id=\"newserver\">NEW SERVER</text>\n<text id=\"testagain\">TEST AGAIN</text>\n<text id=\"uploadspeed\">UPLOAD SPEED</text>\n<text id=\"downloadspeed\">DOWNLOAD SPEED</text>\n<text id=\"kbps\">kbps</text>\n<text id=\"Mbps\">Mbps</text>\n<text id=\"begintest\">BEGIN TEST</text>\n<text id=\"startclosest\">START TEST TO RECOMMENDED SERVER</text>\n<text id=\"long-MB/s\">megabytes</text>\n<text id=\"long-kB/s\">kilobytes</text>\n<text id=\"kB/s\">kB/s</text>\n<text id=\"MB/s\">MB/s</text>\n<text id=\"mbps\">Mbps</text>\n<text id=\"ratinghelp\">How happy are you with your current Internet service provider?</text>\n<text id=\"rating1\">Very unhappy</text>\n<text id=\"rating2\">Unhappy</text>\n<text id=\"rating3\">Neutral</text>\n<text id=\"rating4\">Happy</text>\n<text id=\"rating5\">Very happy</text>\n<text id=\"speedwavebegin\">YOUR RESULT WILL BECOME PART OF A SPEED WAVE</text>\n<text id=\"ping\">PING</text>\n<text id=\"hostedby\">Hosted by</text>\n<text id=\"counterdescription\">TOTAL TESTS\nTO DATE</text>\n<text id=\"copied\">COPIED</text>\n<text id=\"autostartdesc\">AUTO STARTING SPEED TEST IN</text>\n<text id=\"seconds\">SECONDS</text>\n<text id=\"second\">SECOND</text>\n<text id=\"error\">ERROR</text>\n<text id=\"tryagain\">Try Again</text>\n<text id=\"share-wavetitle\">START A SPEED WAVE</text>\n<text id=\"share-namewave\">Speed Wave Name</text>\n<text id=\"share-waveresults\">Your result is now part of the Speed Wave!</text>\n<text id=\"compare-yourtest\">Your Result</text>\n<text id=\"survey-surveytitle\">Help Us Understand Broadband Costs</text>\n<text id=\"survey-downloadpackage\">Download Package</text>\n<text id=\"survey-uploadpackage\">Upload Package</text>\n<text id=\"survey-howmuch\">How much do you pay?</text>\n<text id=\"survey-includes\">Includes:</text>\n<text id=\"survey-postalcode\">Is this your postal code?</text>\n<text id=\"survey-submit\">SUBMIT</text>\n<text id=\"share-accounttitle\">GET A FREE OOKLA SPEEDTEST ACCOUNT</text>\n<text id=\"share-accountdescription\">Being logged in would allow you to start a Speed Wave here!\nRegistration is free and only requires a valid email address.</text>\n<text id=\"share-emailaddress\">Your Email Address</text>\n<text id=\"share-twitterurl\">https://twitter.com/share?text=Check%20out%20my%20%40Ookla%20Speedtest%20result!%20What%27s%20your%20speed%3F&amp;url=http%3A%2F%2Fwww.speedtest.net%2Fmy-result%2F{RESULTID}&amp;related=ookla%3ACreators%20of%20Ookla%20Speedtest&amp;hashtags=speedtest</text>\n<text id=\"share-facebookurl\">https://www.facebook.com/dialog/feed?app_id=581657151866321&amp;link=http://www.speedtest.net/my-result/{RESULTID}&amp;description=This%20is%20my%20Ookla%20Speedtest%20result.%20Compare%20your%20speed%20to%20mine!&amp;redirect_uri=http://www.speedtest.net&amp;name=Check%20out%20my%20Ookla%20Speedtest%20results.%20What%27s%20your%20speed%3F</text>\n<text id=\"share-viewwave\">VIEW SPEED WAVE</text>\n<text id=\"share-createwave\">CREATE</text>\n<text id=\"survey-speed\">Speed</text>\n<text id=\"survey-phone\">Phone</text>\n<text id=\"survey-tv\">TV</text>\n<text id=\"survey-package\">What speeds do you pay for?</text>\n<text id=\"survey-thanks\">Thanks for participating in the survey!</text>\n<text id=\"selectingbestserver\">SELECTING BEST SERVER BASED ON PING</text>\n<text id=\"compare-myresults\">MY RESULTS</text>\n<text id=\"share-createaccount\">CREATE</text>\n<text id=\"begintest-preferred\">YOUR PREFERRED SERVER</text>\n<text id=\"begintest-ping\">RECOMMENDED SERVER</text>\n<text id=\"connecting\">CONNECTING</text>\n<text id=\"share-copy\">COPY</text>\n<text id=\"endtest-share-button\">SHARE THIS RESULT</text>\n<text id=\"endtest-compare-button\">COMPARE \nYOUR RESULT</text>\n<text id=\"endtest-contribute-button\">CONTRIBUTE\nTO NET INDEX</text>\n<text id=\"close\">CLOSE</text>\n<text id=\"survey-retake\">RETAKE THE\nSURVEY</text>\n<text id=\"share-link\">IMAGE</text>\n<text id=\"share-forum\">FORUM</text>\n<text id=\"share-wavedescription\">Use this test result to begin your own Speed Wave!</text>\n<text id=\"pcmagmessage\">Fastest ISPs</text>\n<text id=\"panel0\">wave</text>\n<text id=\"panel1\">share</text>\n<text id=\"panel2\">link:{LANG_CODE}/results.php?source=compare</text>\n<text id=\"panel3\">contribute</text>\n<text id=\"bitspersecond\">bits per second</text>\n<text id=\"endtest\">standard</text>\n<text id=\"lang\">en</text>\n<text id=\"share-pinteresturl\">http://pinterest.com/pin/create/button/?url=http%3A%2F%2Fwww.speedtest.net%2F&amp;media=http%3A%2F%2Fspeedtest.net%2Fresult%2F{RESULTID}.png&amp;description=Check%20out%20my%20result%20from%20Ookla%20Speedtest!</text>\n<text id=\"panelsuffix\"></text>\n<text id=\"survey-nextbtn\">Continue</text>\n<text id=\"survey-editbtn\">EDIT</text>\n<text id=\"survey-download\">Download</text>\n<text id=\"survey-download-validate\">Download:</text>\n<text id=\"survey-upload\">Upload</text>\n<text id=\"survey-upload-validate\">Upload:</text>\n<text id=\"survey-connectiontype\">Connection Type?</text>\n<text id=\"survey-q1label1\">Home</text>\n<text id=\"survey-q1label2\">Business</text>\n<text id=\"survey-q1label3\">School</text>\n<text id=\"survey-q1label4\">Public Wi-Fi</text>\n<text id=\"survey-q1label5\">Other</text>\n<text id=\"survey-ispconf\">My ISP is:</text>\n<text id=\"survey-q2label1\">Yes</text>\n<text id=\"survey-q2label2\">Wrong</text>\n<text id=\"survey-q3label1\">Yes</text>\n<text id=\"survey-q3label2\">Wrong</text>\n<text id=\"survey-postalcode-input\">Please enter your postal code</text>\n<text id=\"survey-labelispinput\">Please enter your ISP name</text>\n<text id=\"survey-okbtn\">OK</text>\n<text id=\"survey-validationUploadline1\">Please check your upload speed.\n  This seems faster than expected.</text>\n<text id=\"survey-validationAmountline1\">Please check the amount entered.\n    This seems higher than expected.</text>\n<text id=\"survey-validationDownloadline1\">Please check your Download speed.\n  This seems faster than expected.</text>\n<text id=\"share-web\">WEB</text>\n<text id=\"share-html\">EMBED</text>\n<text id=\"endtest-contribute-are-you-on\">Are you on</text>\n<text id=\"endtest-contribute-take-survey\">Take our Broadband Internet Survey!</text>\n<text id=\"endtest-test-again\">TEST AGAIN</text>\n<text id=\"endtest-compare\">COMPARE</text>\n</translation>\n<survey>\n<defaults postal_code=\"\" isp_name=\"Ts Tecnologia E Sistemas Em Redes Ltda\" isp_common_name=\"\"/>\n<currency sign=\"R$\" rate_USD=\"0.2814\"/>\n</survey><panels panel0=\"wave-bd-wide\" panel1=\"share-wide\" panel2=\"link:/results.php?source=compare\" panel3=\"contribute-wide-new:wide\"/>\n<endtest endtest=\"standard-wide-new-1button\" /><override>\n<banner id=\"60\" url=\"http://speedify.com/spotlight/lp-1-1/?source=ookla&amp;campaign=speedtest01&amp;utm_source=speedtest&amp;utm_medium=banner&amp;utm_campaign=speedtest01\" banner=\"http://c.speedtest.net/flash/60speedify1-en.swf\" target=\"_blank\" present=\"true\" />\n\n</override>\n</settings>\n"

    stub_request(:get, "http://www.speedtest.net/speedtest-config.php").
      with(headers: {'Accept'=>'*/*', 'Accept-Encoding'=>'gzip;q=1.0,deflate;q=0.6,identity;q=0.3', 'Host'=>'www.speedtest.net', 'User-Agent'=>'Ruby'}).
      to_return(status: 200, body: body, headers: {})
  end

  it '#ip' do
    subject.ip.must_equal '127.0.0.1'
  end

  describe '#localization' do
    let(:localization) { subject.localization }

    it '#latitude' do
      localization.latitude.must_equal -24.0500
    end

    it '#longitude' do
      localization.longitude.must_equal -52.3667
    end
  end
end
